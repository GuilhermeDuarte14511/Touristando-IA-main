<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Touristando IA — Gerador de Roteiro</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Animate.css -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <!-- AOS (Animate On Scroll) -->
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <!-- PDF -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <!-- Confetti -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  <style>
    :root{
      --bg1:#0b0d14; --bg2:#10152a; --card:#151a2e; --muted:#e5e8ffcc;
      --primary:#8ea0ff; --primary-2:#5a6bff; --accent:#00e0b8;
      --border:#2a3252; --success:#00d98b; --danger:#ff637d;
      --ring:#7486ff;
    }
    html,body{height:100%}
    body{
      color:#fff;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1c2142 0%, transparent 60%),
        radial-gradient(900px 700px at 110% 10%, #1b2a52 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
    }

    .form-control:disabled{
      background-color: #0e1326 !important;
      opacity: 1 !important;
    }

    /* ==== força todos os textos a ficarem brancos ==== */
    a, a:hover, a:focus { color:#fff; text-decoration: underline dotted; }
    .text-secondary, .text-muted, .text-body-secondary,
    .form-text, .link-secondary, .text-white-50,
    .small, small, .tiny, .badge, label, .nav-link { color:#fff !important; }

    /* markdown */
    .md-out{ color:#fff }
    .md-out a{ color:#fff; text-decoration: underline }
    .md-out code, .md-out pre { color:#fff; background:#0e1326; border-radius:8px; }
    .md-out pre{ padding:12px; overflow:auto; }

    /* HERO */
    .hero{ position:relative; overflow:hidden; border-bottom:1px solid var(--border);
      background: linear-gradient(120deg,#1b1f36 0%, #171b30 40%, #111528 100%); }
    .hero::after{ content:""; position:absolute; inset:-40% -40% auto -40%; height:220%;
      background:conic-gradient(from 90deg, rgba(124,140,255,.22), rgba(0,224,184,.14), rgba(124,140,255,.22));
      filter: blur(60px); animation:spin 18s linear infinite; pointer-events:none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* orbes flutuantes */
    .orbs{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .orb{ position:absolute; width:180px; height:180px; border-radius:50%;
      background: radial-gradient(closest-side, rgba(124,140,255,.25), rgba(124,140,255,0));
      filter: blur(8px); animation: floatY 10s ease-in-out infinite; }
    .orb.o1{ left:8%; top:10%; animation-delay: 0s }
    .orb.o2{ right:12%; top:30%; animation-delay: 1.6s }
    .orb.o3{ left:22%; bottom:-40px; width:220px; height:220px; animation-delay: .8s }
    @keyframes floatY{
      0%,100%{ transform: translateY(0px) }
      50%{ transform: translateY(-28px) }
    }

    .glass{ background: rgba(255,255,255,.03); border:1px solid var(--border);
      backdrop-filter: blur(10px); box-shadow: 0 12px 48px rgba(0,0,0,.28); border-radius: 18px;
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease; }
    .glass:hover{ transform: translateY(-2px); border-color:#36407a; box-shadow: 0 18px 64px rgba(0,0,0,.34); }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; color:#fff; transition: transform .2s ease, box-shadow .2s ease }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 12px 38px rgba(0,0,0,.22) }

    .form-control,.form-select{ background:#0e1326; border-color:#243054; color:#fff; transition: box-shadow .2s ease, transform .06s ease }
    .form-control::placeholder{ color:#ffffffcc }
    .form-control:focus,.form-select:focus{ border-color:var(--ring); box-shadow:0 0 0 .25rem rgba(116,134,255,.22) }
    .form-control:active{ transform: scale(.995) }

    .btn{ transition: transform .06s ease, box-shadow .2s ease }
    .btn:active{ transform: translateY(1px) scale(.99) }
    .btn-primary{ background-image: linear-gradient(135deg,var(--primary),var(--primary-2)); border:0; color:#0b0d14 }
    .btn-primary:hover{ filter:brightness(1.08) }
    .btn-outline-light{ border-color:#35406a; color:#fff }
    .btn-outline-light:hover{ background:#35406a; color:#fff }
    .btn-success{ background-image: linear-gradient(135deg, #14f1c6, #00b894); border:0; color:#0b0d14 }

    .tiny{ font-size:.88rem }

    /* TAGS / CHIPS */
    .tag, .chip{
      display:inline-flex; align-items:center; gap:.5rem; padding:.28rem .65rem; border-radius:999px;
      background:#0e1429; border:1px solid #263152; color:#fff; font-size:.8rem;
    }
    .chip{ background:linear-gradient(180deg,#0e1429,#0b1122); border-color:#2a3560 }

    /* LOADER */
    .loader{ --size: 38px; width: var(--size); height: var(--size); border-radius: 50%;
      border: 3px solid rgba(124,140,255,.22); border-top-color: var(--accent); animation: spin 1s linear infinite; }
    .pulse-dot{ width:10px;height:10px;border-radius:50%;background:var(--accent);
      box-shadow:0 0 0 0 rgba(0,224,184,.6); animation:pulse 1.6s infinite; }
    @keyframes pulse{ 0%{box-shadow:0 0 0 0 rgba(0,224,184,.6)} 70%{box-shadow:0 0 0 12px rgba(0,224,184,0)} 100%{box-shadow:0 0 0 0 rgba(0,224,184,0)} }

    /* SKELETON */
    .skeleton{ position:relative; overflow:hidden; border-radius:12px; background:#0f1324; border:1px solid #1c2442 }
    .skeleton::after{ content:""; position:absolute; inset:0; transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
      animation: shimmer 1.6s infinite; }
    @keyframes shimmer{ 100%{ transform: translateX(100%); } }
    .sk-line{ height: 14px; background:#121739; margin:10px 12px; border-radius:6px }
    .sk-line.thick{ height:22px }
    .sk-line.short{ width:65% } .sk-line.mid{ width:85% }

    .toolbar .btn{ border-radius:10px }

    .progress.fake .progress-bar{
      background: linear-gradient(90deg,var(--accent), var(--primary));
      background-size:200% 100%;
      animation: gradientMove 2s linear infinite;
    }
    @keyframes gradientMove{0%{background-position:0 0}100%{background-position:200% 0}}

    /* WIZARD */
    .stepper { display:flex; gap:14px; align-items:center; margin-bottom:12px }
    .step-dot{ width:30px;height:30px;border-radius:50%; display:grid; place-items:center;
      background:#0e1429; border:1px solid #2a3358; color:#b9c4ff; font-weight:700; transition: transform .2s ease }
    .step-dot.active{ background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:#0e1122; transform:scale(1.05) }
    .step-line{ flex:1; height:2px; background:#22305a; }
    .step-title{ font-weight:700; }

    /* Floating back to top */
    #backTop{ position:fixed; right:18px; bottom:18px; z-index: 10; display:none; }

    /* progress de rolagem no topo */
    #scrollProgress{ position:fixed; left:0; top:0; height:3px; width:0; z-index:1050;
      background: linear-gradient(90deg, #00e0b8, #8ea0ff); box-shadow:0 0 12px rgba(0,224,184,.6) }

    .hidden{ display:none !important; }

    /* Motion reduce */
    @media (prefers-reduced-motion: reduce){
      .animate__animated{ animation: none !important; }
      .progress-bar{ animation: none !important; }
    }
  </style>
</head>

<body>
  <!-- progress de rolagem -->
  <div id="scrollProgress"></div>

  <!-- HERO -->
  <section class="hero py-5">
    <div class="orbs">
      <div class="orb o1"></div>
      <div class="orb o2"></div>
      <div class="orb o3"></div>
    </div>
    <div class="container position-relative">
      <div class="row align-items-center g-4">
        <div class="col-lg-7" data-aos="fade-up">
          <div class="glass p-4 p-md-5 tilt">
            <div class="d-flex align-items-center gap-3 mb-2">
              <div class="pulse-dot"></div>
              <span class="text-uppercase tiny">Touristando IA</span>
            </div>
            <h1 class="display-5 fw-bold mb-2">
              <i class="fa-solid fa-earth-americas me-2 text-info"></i>
              Roteiros inteligentes, prontos em segundos
            </h1>
            <p class="lead mb-0">
              Responda às perguntas passo a passo. No final, a IA gera um plano com custos estimados, roteiro dia a dia e dicas.
            </p>
          </div>
        </div>
        <div class="col-lg-5 text-center" data-aos="fade-left" data-aos-delay="150">
          <div class="loader mx-auto my-3"></div>
          <div class="tiny">Geração via endpoint seguro <code>/api/roteiro</code></div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="container my-5">
    <div class="row g-4">
      <!-- WIZARD -->
      <div class="col-lg-5" data-aos="fade-up">
        <div class="card p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="step-title"><i class="fa-solid fa-sliders me-2 text-primary"></i>Assistente de Roteiro</div>
            <div class="tiny"><span id="stepNow">1</span>/<span id="stepTotal">8</span></div>
          </div>

          <div class="stepper mb-3">
            <div class="step-dot" data-step="1">1</div><div class="step-line"></div>
            <div class="step-dot" data-step="2">2</div><div class="step-line"></div>
            <div class="step-dot" data-step="3">3</div><div class="step-line"></div>
            <div class="step-dot" data-step="4">4</div><div class="step-line"></div>
            <div class="step-dot" data-step="5">5</div><div class="step-line"></div>
            <div class="step-dot" data-step="6">6</div><div class="step-line"></div>
            <div class="step-dot" data-step="7">7</div><div class="step-line"></div>
            <div class="step-dot" data-step="8">8</div>
          </div>

          <div class="progress fake mb-3" aria-hidden="true">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:12%"></div>
          </div>

          <form id="wizard" class="row g-3" autocomplete="off">
            <!-- STEP 1 -->
            <div class="step" data-step="1">
              <label class="form-label">Passo 1 — Qual o destino?</label>
              <div class="input-group">
                <span class="input-group-text bg-transparent text-secondary"><i class="fa-solid fa-location-dot"></i></span>
                <input id="destino" class="form-control" placeholder="Portugal, Califórnia, Lisboa, Nordeste..." required>
              </div>
              <div class="form-text tiny">Pode ser país, estado/região ou cidade.</div>
            </div>

            <!-- STEP 2 -->
            <div class="step hidden" data-step="2">
              <label class="form-label">Passo 2 — Quantos dias?</label>
              <div class="input-group">
                <span class="input-group-text bg-transparent text-secondary"><i class="fa-regular fa-calendar"></i></span>
                <input id="dias" type="number" class="form-control" value="5" min="1">
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="step hidden" data-step="3">
              <label class="form-label">Passo 3 — Quantas pessoas?</label>
              <div class="input-group">
                <span class="input-group-text bg-transparent text-secondary"><i class="fa-solid fa-user-group"></i></span>
                <input id="pessoas" type="number" class="form-control" value="2" min="1">
              </div>
              <div class="form-text tiny">Usaremos isso para calcular valores por pessoa e totais.</div>
            </div>

            <!-- STEP 4 -->
            <div class="step hidden" data-step="4">
              <label class="form-label">Passo 4 — Orçamento por pessoa (BRL) <span class="tiny">(opcional)</span></label>
              <div class="input-group">
                <span class="input-group-text bg-transparent text-secondary"><i class="fa-solid fa-wallet"></i></span>
                <input id="orcamentoPessoa" type="number" class="form-control" placeholder="1500">
              </div>
              <div class="form-text tiny">Se preencher aqui e o total estiver vazio, calculamos o total automaticamente.</div>
            </div>

            <!-- STEP 5 -->
            <div class="step hidden" data-step="5">
              <label class="form-label">Passo 5 — Orçamento total do grupo (BRL) <span class="tiny">(opcional)</span></label>
              <div class="input-group">
                <span class="input-group-text bg-transparent text-secondary"><i class="fa-solid fa-coins"></i></span>
                <input id="orcamento" type="number" class="form-control" placeholder="3500">
              </div>
              <div class="form-text tiny">Pode deixar vazio. Se informar o total, estimaremos o valor por pessoa.</div>
            </div>

            <!-- STEP 6 -->
            <div class="step hidden" data-step="6">
              <label class="form-label">Passo 6 — Preferências</label>
              <div class="row g-2">
                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text bg-transparent text-secondary"><i class="fa-solid fa-person-walking-luggage"></i></span>
                    <select id="perfil" class="form-select">
                      <option value="econômico">Econômico</option>
                      <option value="normal" selected>Normal</option>
                      <option value="conforto">Conforto</option>
                    </select>
                  </div>
                  <div class="form-text tiny">Nível de gasto desejado.</div>
                </div>
                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text bg-transparent text-secondary"><i class="fa-solid fa-heart"></i></span>
                    <select id="estilo" class="form-select">
                      <option value="casual" selected>Viagem casual</option>
                      <option value="aventura">Com aventuras</option>
                      <option value="romântica">Romântica</option>
                    </select>
                  </div>
                  <div class="form-text tiny">Usamos isso para ajustar atrações e sugestões.</div>
                </div>
              </div>
            </div>

            <!-- STEP 7 -->
            <div class="step hidden" data-step="7">
              <label class="form-label">Passo 7 — Enviar por e-mail <span class="tiny">(opcional)</span></label>
              <div class="input-group">
                <span class="input-group-text bg-transparent text-secondary"><i class="fa-regular fa-envelope"></i></span>
                <input id="email" type="email" class="form-control" placeholder="voce@exemplo.com">
              </div>
              <div class="form-text tiny">Se o backend (SendGrid) estiver ativo, mandamos o roteiro em HTML.</div>
            </div>

            <!-- STEP 8 -->
            <div class="step hidden" data-step="8">
              <label class="form-label">Passo 8 — Revisão &amp; Gerar</label>
              <div class="d-flex flex-wrap gap-2 mb-2" id="reviewTags"></div>
              <div class="tiny">Conferiu tudo? Clique em <b>Gerar roteiro</b> ou pressione <kbd>Ctrl</kbd>+<kbd>Enter</kbd>.</div>
            </div>

            <div id="alert" class="alert alert-danger d-none" role="alert"></div>

            <div class="d-grid d-md-flex gap-2 mt-2">
              <button id="btnBack" class="btn btn-outline-light" type="button">
                <i class="fa-solid fa-arrow-left-long me-1"></i>Voltar
              </button>
              <button id="btnNext" class="btn btn-primary" type="button">
                <i class="fa-solid fa-arrow-right-long me-1"></i>Avançar
              </button>
              <button id="btnGenerate" class="btn btn-success hidden" type="button">
                <i class="fa-solid fa-wand-magic-sparkles me-1"></i>Gerar roteiro
              </button>
              <button id="btnReset" class="btn btn-outline-light ms-auto" type="button">
                <i class="fa-regular fa-trash-can me-1"></i>Limpar
              </button>
            </div>
          </form>

          <div class="mt-3">
            <div class="tiny">Resumo rápido</div>
            <div id="liveTags" class="d-flex flex-wrap gap-2 tiny"></div>
          </div>
        </div>
      </div>

      <!-- RESULT -->
      <div class="col-lg-7" data-aos="fade-up" data-aos-delay="100">
        <div class="card p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-3"><i class="fa-solid fa-list-check me-2 text-success"></i>Resultado</h5>
            <div class="toolbar d-flex flex-wrap gap-2">
              <button id="btnCopy" class="btn btn-outline-light btn-sm" title="Copiar MD"><i class="fa-regular fa-copy me-1"></i>Copiar MD</button>
              <button id="btnCopyHTML" class="btn btn-outline-light btn-sm" title="Copiar HTML"><i class="fa-regular fa-clone me-1"></i>Copiar HTML</button>
              <button id="btnDownload" class="btn btn-outline-light btn-sm" title="Baixar .md"><i class="fa-solid fa-download me-1"></i>.md</button>
              <button id="btnPdf" class="btn btn-outline-light btn-sm" title="Exportar PDF"><i class="fa-regular fa-file-pdf me-1"></i>PDF</button>
              <button id="btnToggleRaw" class="btn btn-outline-light btn-sm" title="Alternar Raw/Render"><i class="fa-solid fa-code me-1"></i>Raw</button>
              <button id="btnZoom" class="btn btn-outline-light btn-sm" title="Fonte maior"><i class="fa-solid fa-a me-1"></i>Aa</button>
            </div>
          </div>

          <!-- meta chips -->
          <div id="metaChips" class="d-flex flex-wrap gap-2 mb-2"></div>

          <!-- skeleton -->
          <div id="skeleton" class="skeleton d-none" aria-hidden="true">
            <div class="sk-line thick mt-3 mx-3"></div>
            <div class="sk-line mid"></div>
            <div class="sk-line"></div>
            <div class="sk-line short"></div>
            <div class="sk-line thick mt-4 mx-3"></div>
            <div class="sk-line mid"></div>
            <div class="sk-line"></div>
            <div class="sk-line short"></div>
          </div>

          <div id="progressBox" class="d-none">
            <div class="progress fake" role="progressbar" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar progress-bar-striped progress-bar-animated" style="width:20%"></div>
            </div>
            <div class="tiny mt-2" id="loadingMsg"><i class="fa-regular fa-clock me-1"></i>Aguarde — montando seu roteiro…</div>
          </div>

          <article id="result" class="md-out" style="min-height:220px">
            <p>Conclua o assistente e gere seu roteiro.</p>
          </article>
          <pre id="resultRaw" class="md-out hidden"><code></code></pre>
        </div>
      </div>
    </div>
  </main>

  <footer class="container text-center py-4 tiny" data-aos="fade-in">
    <span>© Touristando IA — interface de demonstração</span>
  </footer>

  <!-- Toast (feedback) -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastText">Pronto!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Back to top -->
  <button id="backTop" class="btn btn-outline-light btn-sm rounded-pill"><i class="fa-solid fa-arrow-up"></i></button>

  <!-- jQuery + Bootstrap Bundle -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Marked (Markdown -> HTML) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- DOMPurify (sanitize) -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <!-- AOS -->
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    // ========= AOS =========
    AOS.init({ duration: 800, easing: 'ease-out-cubic', once: true, offset: 80 });

    // ========= refs =========
    const $wizard = $('#wizard');
    const $steps = $('.step');
    const totalSteps = $steps.length;
    const $stepNow = $('#stepNow'), $stepTotal = $('#stepTotal');
    const $progressBar = $('#progressBar');
    const $btnBack = $('#btnBack'), $btnNext = $('#btnNext'), $btnGenerate = $('#btnGenerate'), $btnReset = $('#btnReset');
    const $alert = $('#alert'), $liveTags = $('#liveTags'), $reviewTags = $('#reviewTags');
    const $sk = $('#skeleton'), $progBox = $('#progressBox'), $res = $('#result'), $resRaw = $('#resultRaw');
    const $btnCopy = $('#btnCopy'), $btnCopyHTML = $('#btnCopyHTML'), $btnDownload = $('#btnDownload'), $btnPdf = $('#btnPdf'), $btnToggleRaw = $('#btnToggleRaw'), $btnZoom = $('#btnZoom');
    const $metaChips = $('#metaChips');
    const toast = new bootstrap.Toast(document.getElementById('toast'), { delay: 2000 });

    const $destino = $('#destino'),
          $dias = $('#dias'),
          $pessoas = $('#pessoas'),
          $orcPessoa = $('#orcamentoPessoa'),
          $orc = $('#orcamento'),
          $perfil = $('#perfil'),
          $estilo = $('#estilo'),
          $email = $('#email');

    // ========= state =========
    let current = 1, isLoading = false, lastMd = '', lastHtml = '';
    $stepTotal.text(totalSteps);

    // ========= helpers =========
    const mkTag = (icon, text) => $(`<span class="tag"><i class="${icon}"></i> ${text}</span>`);
    const mkChip = (icon, text) => $(`<span class="chip"><i class="${icon}"></i> ${text}</span>`);

    function updateSummary() {
      $liveTags.empty();
      if ($destino.val().trim()) $liveTags.append(mkTag('fa-solid fa-location-dot', $destino.val().trim()));
      const d = +($dias.val() || 0); if (d>0) $liveTags.append(mkTag('fa-regular fa-calendar', `${d} dia(s)`));
      const p = +($pessoas.val() || 0); if (p>0) $liveTags.append(mkTag('fa-solid fa-user-group', `${p} pessoa(s)`));
      const op = +($orcPessoa.val() || 0); if (op>0) $liveTags.append(mkTag('fa-solid fa-wallet', `R$ ${op.toLocaleString('pt-BR')} p/pessoa`));
      const o = +($orc.val() || 0);  if (o>0) $liveTags.append(mkTag('fa-solid fa-coins', `Total: R$ ${o.toLocaleString('pt-BR')}`));
      if ($perfil.val()) $liveTags.append(mkTag('fa-solid fa-user', `Perfil: ${$perfil.val()}`));
      if ($estilo.val()) $liveTags.append(mkTag('fa-solid fa-heart', `Estilo: ${$estilo.val()}`));
      if ($email.val().trim()) $liveTags.append(mkTag('fa-regular fa-envelope', $email.val().trim()));
    }

    function syncBudgets(){
      const p  = parseInt($pessoas.val() || 0, 10);
      const pp = parseFloat($orcPessoa.val() || 0);   // orçamento por pessoa
      const tt = parseFloat($orc.val() || 0);         // total

      // Se houver pessoas + valor por pessoa -> calcula TOTAL automaticamente
      if (p > 0 && pp > 0) {
        const calc = Math.round(p * pp);
        $orc.val(calc)
            .prop('disabled', true)                   // trava o campo total (evita conflito)
            .attr('title', 'Calculado automaticamente: pessoas × valor por pessoa');
        $('#orcAutoHint').removeClass('d-none');
      } else {
        // Libera o campo total quando não há valor por pessoa
        $orc.prop('disabled', false).removeAttr('title');
        $('#orcAutoHint').addClass('d-none');

        // Se o TOTAL existir e valor/pessoa estiver vazio -> calcula valor/pessoa
        if (tt > 0 && p > 0 && (!pp || pp === 0)) {
          $orcPessoa.val(Math.round(tt / p));
        }
      }

      // mantém os resumos em sincronia
      updateSummary();
      buildReview();
    }

    [$destino,$dias,$pessoas,$orcPessoa,$orc,$perfil,$estilo,$email].forEach($el =>
      $el.on('input change', ()=>{ syncBudgets(); updateSummary(); persistState(); })
    );
    updateSummary();

    function setAlert(msg){
      $alert.html(msg).removeClass('d-none').addClass('animate__animated animate__shakeX');
      setTimeout(()=> $alert.removeClass('animate__animated animate__shakeX'), 600);
    }
    function clearAlert(){ $alert.addClass('d-none').text(''); }

    function showStep(n){
      current = n;
      $steps.addClass('hidden');
      $steps.filter(`[data-step="${n}"]`).removeClass('hidden').addClass('animate__animated animate__fadeInUp');
      setTimeout(()=> $steps.removeClass('animate__animated animate__fadeInUp'), 400);
      $stepNow.text(n);
      // step dots
      $('.step-dot').each(function(){
        const i = +$(this).data('step');
        $(this).toggleClass('active', i<=n);
      });
      // progress %
      const pct = Math.max(12, Math.round((n-1)/(totalSteps-1)*100));
      $progressBar.css('width', pct+'%');
      // buttons
      $btnBack.prop('disabled', n===1 || isLoading);
      $btnNext.toggleClass('hidden', n===totalSteps);
      $btnGenerate.toggleClass('hidden', n!==totalSteps);
      clearAlert();
      buildReview();
      // focus
      setTimeout(()=> {
        const $input = $steps.filter(`[data-step="${n}"]`).find('input,select').first();
        $input.trigger('focus');
      }, 80);
    }

    function buildReview(){
      $reviewTags.empty();
      if(current!==totalSteps) return;
      if ($destino.val().trim()) $reviewTags.append(mkTag('fa-solid fa-location-dot', $destino.val().trim()));
      const d = +($dias.val() || 0); if (d>0) $reviewTags.append(mkTag('fa-regular fa-calendar', `${d} dia(s)`));
      const p = +($pessoas.val() || 0); if (p>0) $reviewTags.append(mkTag('fa-solid fa-user-group', `${p} pessoa(s)`));
      const op = +($orcPessoa.val() || 0);
      $reviewTags.append(mkTag('fa-solid fa-wallet', op>0 ? `R$ ${op.toLocaleString('pt-BR')} p/pessoa` : 'Sem valor/pessoa'));
      const o = +($orc.val() || 0);
      $reviewTags.append(mkTag('fa-solid fa-coins', o>0 ? `Total: R$ ${o.toLocaleString('pt-BR')}` : 'Sem total'));
      if ($perfil.val()) $reviewTags.append(mkTag('fa-solid fa-user', `Perfil: ${$perfil.val()}`));
      if ($estilo.val()) $reviewTags.append(mkTag('fa-solid fa-heart', `Estilo: ${$estilo.val()}`));
      $reviewTags.append(mkTag('fa-regular fa-envelope', $email.val().trim() || 'Não enviar por e-mail'));
    }

    function validateStep(n){
      if(n===1 && !$destino.val().trim()) { setAlert('Informe o destino (país/estado/cidade).'); return false; }
      if(n===2){
        const d = +($dias.val()||0);
        if(!Number.isFinite(d) || d<=0){ setAlert('Informe um número de dias válido.'); return false; }
      }
      if(n===3){
        const p = +($pessoas.val()||0);
        if(!Number.isFinite(p) || p<=0){ setAlert('Informe a quantidade de pessoas.'); return false; }
      }
      if(n===4){
        const v = $orcPessoa.val();
        if(v && +v<0){ setAlert('Orçamento por pessoa não pode ser negativo.'); return false; }
      }
      if(n===5){
        const v = $orc.val();
        if(v && +v<0){ setAlert('Orçamento total não pode ser negativo.'); return false; }
      }
      if(n===7){
        const e = $email.val().trim();
        if(e && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){ setAlert('E-mail inválido.'); return false; }
      }
      return true;
    }

    function nextStep(){ if(!isLoading && validateStep(current) && current<totalSteps) showStep(current+1); }
    function prevStep(){ if(!isLoading && current>1) showStep(current-1); }

    // ENTER => avançar (exceto no último)
    $wizard.on('keydown', 'input,select', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); (current<totalSteps? nextStep(): null); }});

    // atalhos
    document.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key === 'Enter' && current===totalSteps){ e.preventDefault(); generate(); }
      if(e.key === 'Escape'){ prevStep(); }
    });

    // buttons
    $btnNext.on('click', nextStep);
    $btnBack.on('click', prevStep);
    $btnReset.on('click', ()=>{
      if(isLoading) return;
      localStorage.removeItem('touristando_state');
      $wizard[0].reset();
      updateSummary(); clearAlert();
      showStep(1);
      $metaChips.empty();
      $res.removeClass('hidden'); $resRaw.addClass('hidden');
      $res.html('<p>Conclua o assistente e gere seu roteiro.</p>');
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // ====== Loading ======
    let progTimer=null, loadingPhrases=[
      'Buscando moeda e país do destino…',
      'Consultando câmbio para BRL…',
      'Montando atrações e hospedagens…',
      'Finalizando roteiro em Markdown…'
    ];
    function setLoading(on){
      isLoading = on;
      $btnGenerate.prop('disabled', on);
      $btnNext.prop('disabled', on);
      $btnBack.prop('disabled', on || current===1);
      if(on){ $sk.removeClass('d-none'); $progBox.removeClass('d-none'); startFakeProgress(); }
      else  { $sk.addClass('d-none');   $progBox.addClass('d-none');   stopFakeProgress(); }
    }
    function startFakeProgress(){
      const bar = $('.progress-bar'); let w = 14, i = 0;
      bar.css('width', w+'%');
      $('#loadingMsg').html('<i class="fa-regular fa-clock me-1"></i>'+loadingPhrases[0]);
      progTimer = setInterval(()=>{
        w = Math.min(98, w + Math.random()*10);
        bar.css('width', w+'%');
        if(w>25 && i===0){ i=1; $('#loadingMsg').html('<i class="fa-regular fa-clock me-1"></i>'+loadingPhrases[1]); }
        if(w>55 && i===1){ i=2; $('#loadingMsg').html('<i class="fa-regular fa-clock me-1"></i>'+loadingPhrases[2]); }
        if(w>80 && i===2){ i=3; $('#loadingMsg').html('<i class="fa-regular fa-clock me-1"></i>'+loadingPhrases[3]); }
      }, 600);
    }
    function stopFakeProgress(){
      clearInterval(progTimer); progTimer=null; $('.progress-bar').css('width','100%');
      setTimeout(()=> $('.progress-bar').css('width', `${Math.max(12, Math.round((current-1)/(totalSteps-1)*100))}%`), 500);
    }

    // ====== persistência local ======
    function persistState(){
      const st = {
        destino:$destino.val(),
        dias:$dias.val(),
        pessoas:$pessoas.val(),
        orcPessoa:$orcPessoa.val(),
        orc:$orc.val(),
        perfil:$perfil.val(),
        estilo:$estilo.val(),
        email:$email.val()
      };
      localStorage.setItem('touristando_state', JSON.stringify(st));
    }
    (function restoreState(){
      try{
        const st = JSON.parse(localStorage.getItem('touristando_state')||'{}');
        if(st.destino) $destino.val(st.destino);
        if(st.dias)    $dias.val(st.dias);
        if(st.pessoas) $pessoas.val(st.pessoas);
        if(st.orcPessoa) $orcPessoa.val(st.orcPessoa);
        if(st.orc)     $orc.val(st.orc);
        if(st.perfil)  $perfil.val(st.perfil);
        if(st.estilo)  $estilo.val(st.estilo);
        if(st.email)   $email.val(st.email);
        syncBudgets();
        updateSummary();
      }catch{}
    })();

    // ====== generate ======
    async function generate(){
      if(!validateStep(totalSteps) || isLoading) return;
      const payload = {
        destino: $destino.val().trim(),
        dias: Number($dias.val() || 5),
        pessoas: Number($pessoas.val() || 1),
        orcamento_por_pessoa: $('#orcamentoPessoa').val() ? Number($('#orcamentoPessoa').val()) : null,
        orcamento: $('#orcamento').val() ? Number($('#orcamento').val()) : null,
        perfil: $perfil.val(),
        estilo: $estilo.val(),
        emailDestino: $email.val().trim() || null
      };
      setLoading(true);
      $res.html('<p>Solicitando à IA…</p>');
      document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });

      try{
        const resp = await fetch('/api/roteiro', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data?.error || 'Falha ao gerar roteiro');

        // Meta chips (moeda, taxa, destino, pessoas, estilo)
        $metaChips.empty();
        if(data.meta){
          if(data.meta.destino) $metaChips.append(mkChip('fa-solid fa-map-pin', data.meta.destino));
          if(data.meta.pessoas) $metaChips.append(mkChip('fa-solid fa-user-group', `${data.meta.pessoas} pessoa(s)`));
          if(data.meta.estilo)  $metaChips.append(mkChip('fa-solid fa-heart', `Estilo: ${data.meta.estilo}`));
          if(data.meta.currency_code) $metaChips.append(mkChip('fa-solid fa-money-bill', `Moeda: ${data.meta.currency_code}`));
          if(data.meta.fx && data.meta.fx.brl_to_local){
            const val = Number(data.meta.fx.brl_to_local).toFixed(4);
            $metaChips.append(mkChip('fa-solid fa-scale-balanced', `1 BRL = ${val} ${data.meta.currency_code}`));
          }
          if(data.meta.fx && data.meta.fx.date){
            $metaChips.append(mkChip('fa-regular fa-calendar', `Taxa: ${data.meta.fx.date}`));
          }
          if(data.meta.orcamento_por_pessoa){
            $metaChips.append(mkChip('fa-solid fa-wallet', `R$ ${Number(data.meta.orcamento_por_pessoa).toLocaleString('pt-BR')} p/pessoa`));
          }
          if(data.meta.orcamento){
            $metaChips.append(mkChip('fa-solid fa-coins', `Total: R$ ${Number(data.meta.orcamento).toLocaleString('pt-BR')}`));
          }
        }

        // Render Markdown (sanitizado) + guardamos versão MD
        lastMd = (data.texto || '').trim() || '(sem conteúdo)';
        marked.setOptions({ mangle:false, headerIds:false });
        const renderer = new marked.Renderer();
        const _link = renderer.link;
        renderer.link = function(href,title,text){
          const html = _link.call(this, href, title, text);
          return html.replace(/^<a /, '<a target="_blank" rel="noopener noreferrer" ');
        };
        const unsafe = marked.parse(lastMd, { renderer });
        lastHtml = DOMPurify.sanitize(unsafe);
        $res.html(lastHtml);
        $resRaw.find('code').text(lastMd);

        confetti({ particleCount: 90, spread: 90, origin:{ y: 0.2 }});

        $('#toastText').text('Roteiro gerado!');
        toast.show();
      }catch(err){
        setAlert(err.message || String(err));
        $res.html('<p class="text-danger">Não foi possível gerar o roteiro.</p>');
      }finally{
        setLoading(false);
      }
    }
    $btnGenerate.on('click', generate);

    // Ações do resultado
    $btnCopy.on('click', async ()=>{
      try{
        await navigator.clipboard.writeText(lastMd || ($res.text() || ''));
        $('#toastText').text('Markdown copiado!');
        toast.show();
      } catch(_){ setAlert('Não foi possível copiar.'); }
    });

    $btnCopyHTML.on('click', async ()=>{
      try{
        await navigator.clipboard.writeText(lastHtml || $res.html() || '');
        $('#toastText').text('HTML copiado!');
        toast.show();
      } catch(_){ setAlert('Não foi possível copiar HTML.'); }
    });

    $btnDownload.on('click', ()=>{
      const content = lastMd || $res.text() || '';
      const blob = new Blob([content], {type:'text/markdown;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      const name = ($destino.val() || 'roteiro').toString().replace(/[^\w\-]+/g,'_');
      a.download = `roteiro_${name}.md`; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    });

    $btnPdf.on('click', ()=>{
      const element = document.createElement('div');
      element.innerHTML = `
        <div style="font-family: Arial, Helvetica, sans-serif; color:#111">
          <h2 style="margin-top:0">Roteiro — ${$destino.val() || 'Destino'}</h2>
          <div>${lastHtml || $res.html() || ''}</div>
        </div>`;
      const opt = {
        margin: 10,
        filename: `roteiro_${($destino.val()||'destino').toString().replace(/[^\w\-]+/g,'_')}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().from(element).set(opt).save();
    });

    $btnToggleRaw.on('click', ()=>{
      const rawMode = !$resRaw.hasClass('hidden');
      if(rawMode){
        $resRaw.addClass('hidden'); $res.removeClass('hidden');
      }else{
        $res.addClass('hidden'); $resRaw.removeClass('hidden');
      }
    });

    // alternar fonte maior no resultado
    let zoomed = false;
    $btnZoom.on('click', ()=>{
      zoomed = !zoomed;
      $res.css('font-size', zoomed ? '1.08rem' : '');
      $res.find('h1,h2').css('font-size', zoomed ? '' : '');
    });

    // Back to top
    const $backTop = $('#backTop');
    $(window).on('scroll', ()=>{
      $backTop.toggle($(window).scrollTop()>300);
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = (window.scrollY / Math.max(1,h)) * 100;
      document.getElementById('scrollProgress').style.width = pct + '%';
    });
    $backTop.on('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

    // efeito tilt leve nos cards com .tilt
    (function tilt(){
      const els = document.querySelectorAll('.tilt');
      els.forEach(el=>{
        el.addEventListener('mousemove', (e)=>{
          const r = el.getBoundingClientRect();
          const cx = r.left + r.width/2;
          const cy = r.top + r.height/2;
          const dx = (e.clientX - cx) / (r.width/2);
          const dy = (e.clientY - cy) / (r.height/2);
          el.style.transform = `rotateX(${(-dy*3).toFixed(2)}deg) rotateY(${(dx*3).toFixed(2)}deg) translateY(-2px)`;
        });
        el.addEventListener('mouseleave', ()=>{ el.style.transform = ''; });
      });
    })();

    // init
    showStep(1);
  </script>
</body>
</html>
